<!DOCTYPE html>
<html>
<title>Vokabeltrainer</title>
<link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="assets/css/app.css">
<link rel="stylesheet" href="assets/css/colors.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
</head>

<body>
    <header class="bg-green">
        <img src="assets/images/vocabulary-names.png" class="mx-auto d-block" style="width: 474px; height: 82px;" alt="Card image cap">
        <!-- <h1 class="text-center">Vocabulary Trainer</h1> -->
    </header>

    <div class="container-fluid body-content">
        <div id="navigationsCards">
            <div class="col-lg-12 keyvisual row">
                <img class="card-img-top text-center vocabulary-keyvisual" src="assets/images/vocabulary.jpg" alt="Card image cap">
            </div>
            <div>

                <div id="fileStructure" class="row">
                    <!-- file parser result added here-->
                </div>
            </div>
        </div>
        <div id='testCard' class="row">
            <div class="col-sm-12 col-lg-12 col-xl-12">
                <!-- VOCABULARY CARD -->
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="p-2 bd-highlight">
                                <h1>
                                    <span id="vocabulary-phase" class="badge badge-pill badge-info" data-badge-caption="Phase">4</span>
                                </h1>
                            </div>
                            <div class="mr-auto p-2">
                                <h2 id="vocabulary-word">No Data</h2>
                            </div>
                            <div class="p-2 bd-highlight">
                                <span id="vocabulary-rerun" class="badge badge-warning" data-badge-caption="Correct">Rerun 4</span>
                            </div>
                            <div class="p-2 bd-highlight">
                                <span id="vocabulary-correct" class="badge badge-success" data-badge-caption="Correct">Correct 4</span>
                            </div>
                            <div class="p-2 bd-highlight">
                                <span id="vocabulary-error" class="badge badge-danger right" data-badge-caption="Error">Error 4</span>
                            </div>
                            <div class="p-2 bd-highlight">
                                <span id="vocabulary-remaining" class="badge badge-info" data-badge-caption="Remaining">Remaining 4</span>
                            </div>

                            <div class="p-2 bd-highlight">
                                <button id="test-close" type="button" class="close" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        </div>



                        <div class="row">
                            <div id="errorDisplay" class="col-12">

                            </div>
                        </div>
                    </div>
                    <form onsubmit="return false">
                        <div class="form-group">
                            <div class="card-body">



                                <div class="row">
                                    <div class="col-3">
                                        <label for="exampleInputEmail1">Your translation: </label>
                                    </div>
                                    <div class="col-6">
                                        <input id="vocabulary-translation" size="30" class="form-control" placeholder="..type it here .." autofocus>
                                        <small id="emailHelp" class="form-text text-muted">Provide the translation use colon for multiple Translations see info in [].</small>
                                    </div>
                                    <div class="col-3">
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>
            </div>
            <!-- <div class="col-4">
                <div id='errorCard' class="card">
                    <div class="card-header">
                        <h2>Vocabulary Errors</h2>
                    </div>
                    <div class="card-body">
                        <ul id="errorList"></ul>
                    </div>
                </div>
            </div> -->

        </div>
    </div>
    <footer class="footer bg-green">
        <div class="container">


            <div class="row">
                <div class="col-7">
                    <div id="fileInfoElement">No File Information</div>
                    <button id="settingsButton" class='btn btn-lg ' style='background-color:transparent;'>
                        <image src="assets/images/settings.png"></image>
                    </button>
                    <button id="editData" class="btn btn-default">Edit ..</button>
                    <button id="loadFileButton" class="btn btn-primary">Load File ...</button>
                    <button id="showParseErrors" type="button" class="btn btn-danger">
                        <span id="showParseErrorCount" class="badge badge-light">4</span>
                    </button>&nbsp;


                    <span id="phase-0-label" data-toggle="tooltip" title="Phase 0" class="badge badge-danger">0</span>


                    <span id="phase-1-label" data-toggle="tooltip" title="Phase 1" class="badge badge-danger">0</span>

                    <span id="phase-2-label" data-toggle="tooltip" title="Phase 2" class="badge badge-warning">0</span>

                    <span id="phase-3-label" data-toggle="tooltip" title="Phase 3" class="badge badge-warning">0</span>

                    <span id="phase-4-label" data-toggle="tooltip" title="Phase 4" class="badge badge-success">0</span>

                    <span id="phase-5-label" data-toggle="tooltip" title="Phase 5" class="badge badge-success">0</span>
                    &nbsp;
                    <button id="phase-question-due" data-toggle="tooltip" title="Questions due today" type="button" class="btn btn-info">
                        <span id="showParseErrorCount" class="badge badge-light">34</span>
                    </button>
                </div>

                <div class="col-5">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="speechActive">
                        <label class="form-check-label" for="exampleCheck1">Speech</label>
                        <i>(Version: 29-04-30)</i>
                    </div>
                    <form onsubmit="return false">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <select id="runtesttype" class="form-control">
                                    <option value="DE" selected>Deutsch</option>
                                    <option value="EN">English/Latein</option>
                                    <!--option value="MIX">Mixed</option-->

                                </select>
                            </div>
                            <select id="runtestcount" class="form-control">
                                <option value="20">20 words</option>
                                <option value="30" selected>30 words</option>
                                <option value="40">40 words</option>
                                <option value="50">50 words</option>
                                <option value="100">100 words</option>
                                <option value="150">150 words</option>
                                <option value="999">All</option>
                            </select>
                            <div class="input-group-append">
                                <button id="runtest" class="btn btn-success">Start</button>

                            </div>
                        </div>
                    </form>


                </div>
                </form>
            </div>
        </div>
    </footer>
    </div>
    <script>
        const log = require('electron-log');
        log.debug('[MW] mainWindow.html');
        const electron = require('electron');
        const swal = require('sweetalert2');
        const say = require('say');

        var parseErrorsList = []; // store last parseErrors

        const {
            ipcRenderer
        } = electron;

        // Buttons
        const runTestButton = document.querySelector('#runtest');
        const editDataButton = document.querySelector('#editData');
        const settingsButton = document.querySelector('#settingsButton');
        const runTestCountElement = document.querySelector('#runtestcount');
        const runTestTypeElement = document.querySelector('#runtesttype');
        const loadFileButton = document.querySelector('#loadFileButton');

        const fileInfoElement = document.querySelector('#fileInfoElement');
        const wordElement = document.querySelector('#vocabulary-word');
        const translationElement = document.querySelector('#vocabulary-translation');
        const errorElement = document.querySelector('#errorDisplay');
        //  const errorCardElement = document.querySelector('#errorCard');
        // const parseErrorsElement = document.querySelector('#parse-errors-element');
        const parseErrorsText = document.querySelector('#parse-errors');
        const showParseErrorsButton = document.querySelector('#showParseErrors');
        const showParseErrorsCountElement = document.querySelector('#showParseErrorCount');
        const speechActiveCheckBox = document.querySelector('#speechActive');

        const form = document.querySelector('form');

        const testFormCloseElement = document.querySelector('#test-close');
        const phaseElement = document.querySelector('#vocabulary-phase');
        const testErrorElement = document.querySelector('#vocabulary-error');
        const testCorrectElement = document.querySelector('#vocabulary-correct');
        const testRerunElement = document.querySelector('#vocabulary-rerun');
        const testRemainingElement = document.querySelector('#vocabulary-remaining');
        const resultsElement = document.querySelector('#vocabulary-results');

        const testCardElement = document.querySelector('#testCard');
        const navigationCardsElement = document.querySelector('#navigationsCards');
        const fileStructurElement = document.querySelector('#fileStructure');

        const phase0 = document.querySelector('#phase-0-label');
        const phase1 = document.querySelector('#phase-1-label');
        const phase2 = document.querySelector('#phase-2-label');
        const phase3 = document.querySelector('#phase-3-label');
        const phase4 = document.querySelector('#phase-4-label');
        const phase5 = document.querySelector('#phase-5-label');

        const phaseQuestions = document.querySelector('#phase-question-due');

        const phaseCardDiv = document.querySelector('#phase-5-label');

        function createFileCard(fileEntry) {
            var div = document.createElement("div");
            div.className = "mb-2 col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-4";

            var card = document.createElement("div");
            card.className = "card";
            card.style = "min-height:120px";
            div.appendChild(card);

            var cardBody = document.createElement("div");
            cardBody.className = "card-body";
            card.appendChild(cardBody);

            var cardTitle = document.createElement("h6");
            cardTitle.className = "card-title";
            cardTitle.innerHTML = fileEntry.shortName + "(" + fileEntry.total + ")";
            cardBody.appendChild(cardTitle);
            if (fileEntry.phases) {
                for (var p = 0; p <= 5; p++) {
                    var pspan = document.createElement("span");
                    if (p < 2) {
                        pspan.className = "ml-1 badge badge-danger";
                    } else if (p < 4) {
                        pspan.className = "ml-1 badge badge-warning";
                    } else {
                        pspan.className = "ml-1 badge badge-success";
                    }
                    cardBody.appendChild(pspan);
                    pspan.innerHTML = fileEntry.phases[p];
                    pspan.setAttribute("data-toggle", "tooltip");
                    pspan.title = "Phase " + p;
                    log.debug("[MW] CARD %s --> %s", p, fileEntry.phases[p]);
                }
            } else {
                log.debug("[MW] CARD NO PHASE INFO");
            }

            var questions = document.createElement("btn");
            questions.className = "float-right btn btn-sm btn-info";
            questions.setAttribute("data-toggle", "tooltip");
            questions.title = "" + fileEntry.phaseRelevant + " Phase Questions are due";
            questions.innerHTML = fileEntry.phaseRelevant;


            var openFile = document.createElement("a");
            openFile.className = "ml-2 btn btn-sm btn-primary float-right";
            openFile.innerHTML = "Open"
            openFile.setAttribute("href", "#");
            cardBody.appendChild(openFile);
            cardBody.appendChild(questions);

            openFile.addEventListener("click", function () {
                log.debug("[MW] About to load %s", fileEntry.fileName);
                ipcRenderer.send("test:loadFile", fileEntry);
            });

            // add listener
            return div;
        }

        function showTest() {
            log.debug('[MW] show tests ..');
            navigationCardsElement.hidden = true;
            testCardElement.hidden = false;

            runTestButton.disabled = true;
            editDataButton.disabled = true;
            runTestTypeElement.disabled = true;
            runTestCountElement.disabled = true;
            loadFileButton.disabled = true;
            testRerunElement.hidden = true;
        }

        function endTest() {
            log.debug('[MW] hide tests ..');
            testCardElement.hidden = true;
            navigationCardsElement.hidden = false;

            errorElement.innerHTML = '';
            runTestButton.disabled = false;
            editDataButton.disabled = false;
            runTestTypeElement.disabled = false;
            runTestCountElement.disabled = false;
            loadFileButton.disabled = false;
        }

        function displayQuestion(testRun) {
            log.debug('[MW] test:display');
            log.debug(testRun);
            if (testRun.type == "EN" && testRun.currentEntry.translations.length > 1 ) {
                wordElement.innerHTML = testRun.currentEntry.ask + " [" + testRun.currentEntry.translations.length +
                    "]";
            } else {
                wordElement.innerHTML = testRun.currentEntry.ask;
            }
            wordElement.className = "animated fadeInLeft";
            var remaining = testRun.targetCount - testRun.correct - testRun.error;
            testRemainingElement.innerHTML = remaining;
            phaseElement.innerHTML = testRun.currentEntry.phase;
            testErrorElement.innerHTML = testRun.error;
            if (testRun.rerun) {
                testRerunElement.hidden = false;
                testRerunElement.innerHTML = "Rerun"
                testRemainingElement.innerHTML = (testRun.wrongIndex.length + 1 - testRun.currentWrongIndex);
            }
            // reset class
            testCorrectElement.innerHTML = testRun.correct;
            log.debug('[MW] Display StatS : Remaining %s = Total %s - Correct %s - Error %s', remaining,
                testRun.total, testRun.correct, testRun.error);
            translationElement.focus();
        }

        //  clear filestats entries
        ipcRenderer.on('filestats:clear', function (e, entry) {
            log.debug("[MW] Filestats " + enrty);
            fileStructurElement.innerHTML = ""; // remove all
        });

        //  show new filestats entry
        ipcRenderer.on('filestats:newEntry', function (e, entry) {
            log.debug(entry);
            var div = createFileCard(entry);
            fileStructurElement.appendChild(div);
            log.debug("[MW] Filestats added entry ");
        });

        //  show file info
        ipcRenderer.on('test:fileInfo', function (e, vocTest) {
            //   log.debug(vocTest);
            log.debug('[MW] test:fileInfo vocTest Size: %s, Fehler: %s', vocTest.fileContent._entries.length,
                vocTest.fileContent.hasError);
            //    log.debug(vocTest.parseErrors);
            log.debug('[MW] test:short/ fileName: %s / %s', vocTest.shortName, vocTest.fileName);
            fileInfoElement.innerHTML = "Vocabulary: " + vocTest.shortName + " (" + vocTest.fileContent._entries
                .length + ")";
            //vocTest.printInfo();
            // set main display fr file info
            if (vocTest.fileContent.hasError) {
                parseErrorsList = vocTest.fileContent.parseErrors;
                showParseErrorsButton.className = "btn btn-danger";
                showParseErrorsCountElement.innerHTML = vocTest.fileContent.parseErrors.length;
            } else {
                parseErrorsList = [];
                showParseErrorsButton.className = "btn btn-success";
                showParseErrorsCountElement.innerHTML = "OK";
                // popup data remember data for later
            }
            // display phases
            phase0.innerHTML = vocTest.phaseStats[0];
            phase1.innerHTML = vocTest.phaseStats[1];
            phase2.innerHTML = vocTest.phaseStats[2];
            phase3.innerHTML = vocTest.phaseStats[3];
            phase4.innerHTML = vocTest.phaseStats[4];
            phase5.innerHTML = vocTest.phaseStats[5];
            phaseQuestions.innerHTML = vocTest.phaseIndices.length;

        });

        //  show question
        ipcRenderer.on('test:display', function (e, testRun) {
            displayQuestion(testRun);
        });

        // show answer
        ipcRenderer.on('test:result', function (e, testRun) {
            var spanElement = document.createElement("div");
            if (testRun.answerIsCorrect) {
                spanElement.innerHTML = "Richtig!";
                spanElement.className = "alert alert-success"; //role="alert"
                //  spanElement.className = "alert alert-success animated bounce";
                //     testCorrectElement.className += " animated wobble";
                log.debug('[MW] test:result OK');

            } else {
                log.debug('[MW] ***** CORRECT IS %s', testRun.correctTranslations[0]);
                var correctTranslationsText = "";
                for (var ict = 0; ict < testRun.correctTranslations.length; ict++) {
                    if (correctTranslationsText.length > 0) {
                        correctTranslationsText += " / ";
                    }
                    correctTranslationsText += testRun.correctTranslations[ict];
                }
                spanElement.innerHTML = (testRun.type == "DE" ? testRun.currentEntry.translation : testRun.currentEntry
                    .word) + " --> correct answer is: " + correctTranslationsText;
                spanElement.className = "alert alert-danger"; //role="alert"
                if (testRun.type == "DE" && speechActiveCheckBox.checked) {
                    say.speak(testRun.correctTranslations[0]); // there is always only one
                }
                log.debug('[MW] test:result Wrong : %s', correctTranslationsText);
            }
            errorElement.appendChild(spanElement);
        });

        // show over
        ipcRenderer.on('test:over', function (e, testRun) {
            log.debug('[MW] test:over Got result ');
            endTest();
            var successMessage = "You did a test with <br/><span class='text-primary'>" + testRun.targetCount +
                " words</span> , you made <br/><span class='text-danger'>" + testRun.error +
                " errors</span> and <br/><span class='text-success'>" + testRun.correct +
                " correct</span> answers!";

            if (testRun.grade < 2) {
                swal("NOTE: " + testRun.grade + " - Great job!", successMessage, "success");
            } else if (testRun.grade < 3) {
                swal("NOTE: " + testRun.grade + " - Good job!", successMessage, "info");
            } else if (testRun.grade < 4) {
                swal("NOTE: " + testRun.grade + " - Time to Improve!", successMessage, "warning");
            } else {
                swal("NOTE: " + testRun.grade + " - Failed!", successMessage, "error");
            }
            var liElement = document.createElement("li");
            liElement.innerHTML = "<h4>Grade " + testRun.grade + "</h4> (" + testRun.vData.fileName + ")<br/> " +
                successMessage;
            resultsElement.appendChild(liElement);
        });

        // show over
        ipcRenderer.on('test:showWrongAnswers', function (e, testRun) {
            log.debug('[MW] test:show wrong answers ');
            var successMessage = "You made <br/><span class='text-danger'>" + testRun.error +
                " errors</span>!<br/><br/>You will be asked the wrong words again.";


            swal("Wrong answers - Rerun required!", successMessage, "success").then((result) => {
                errorElement.innerHTML = "";
                displayQuestion(testRun);
            });

            var liElement = document.createElement("li");
            liElement.innerHTML = "<h4>Grade " + testRun.grade + "</h4> (" + testRun.vData.fileName + ")<br/> " +
                successMessage;
            resultsElement.appendChild(liElement);
        });

        testFormCloseElement.addEventListener('click', closeTestRun);

        function closeTestRun() {
            log.debug('[MW] endTest');
            endTest();
        }



        showParseErrorsButton.addEventListener('click', closeForm);

        function closeForm() {

            var errors = "";
            if (parseErrorsList && parseErrorsList.length > 0) {
                errors = '<ul class="list-group">';
                for (var i = 0; i < parseErrorsList.length; i++) {
                    var error = parseErrorsList[i];
                    if (error.spellingError) {
                        errors += '<li class="list-group-item">' + error.highlightedWord +
                            " <br/>" +
                            "<small>" + error.error + "</small></li>";
                    } else {
                        errors += '<li class="list-group-item"><span class="text-danger">' + error.word +
                            "</span>  <i>(Data: " + error.raw + ")</i><br/>" +
                            "<small>" + error.error + "</small></li>";
                    }
                }
                errors += "</ul>";
                log.debug("ERRORS" + errors);
                swal("Errors in File!", errors, "error");
            } else {
                swal("No Errors in File!", "Good Job!", "success");
            }
        }

        //
        // runtest
        //
        runTestButton.addEventListener('click', runTest);

        function runTest(e) {
            var count = runTestCountElement.value;
            var type = runTestTypeElement.value;
            log.debug("Run %s with %s", count, type);
            ipcRenderer.send("test:run", count, type);
            showTest();
        }

        editDataButton.addEventListener('click', showEdit);

        function showEdit(e) {
            ipcRenderer.send("data:showEdit");
        }

        settingsButton.addEventListener('click', askScanFolder);

        function askScanFolder() {
            swal({
                title: 'Auswahl Vokabel Datei Ordner',
                text: 'Bitte Ordner eingeben (bspw. /Users/greta/vocabulary):',
                type: 'info',
                input: 'text',
                confirmButtonText: 'Speichern'
            }).then((result) => {
                if (result.value) {

                    log.debug(result.value);
                    ipcRenderer.send("settings:folder", result.value);
                }
                log.debug(result);
            });
        }
        // submit answer
        form.addEventListener('submit', function () {


            var check = {
                word_displayed: wordElement.innerHTML,
                translation_entered: translationElement.value
                //   correct_translations: "" // set in check function
            };
            log.debug('[MW] Submitting %s/%s', check.word_displayed, check.translation_entered);
            ipcRenderer.send("test:answer", check);

            testErrorElement.className = "badge badge-danger right";
            testCorrectElement.className = "badge badge-success";
            translationElement.value = "";
            errorElement.innerHTML = "";
            wordElement.innerHTML = "";
            wordElement.className = "";
        });


        // loaddata
        loadFileButton.addEventListener('click', loadTest);

        function loadTest(e) {
            ipcRenderer.send("test:load")
        }

        endTest();
        // swal({
        //     title: 'Welcome!',
        //     text: "Choose your language!",
        //     type: 'info',
        //     showCancelButton: true,
        //     confirmButtonColor: '#3085d6',
        //     cancelButtonColor: '#d33',
        //     confirmButtonText: 'English',
        //     cancelButtonText: 'Latein',
        //     confirmButtonClass: 'btn btn-success',
        //     cancelButtonClass: 'btn btn-info',
        //     buttonsStyling: false,
        //     reverseButtons: true
        // }).then((result) => {
        //     const ENGLISH = "english";
        //     const LATEIN = "latein";
        //     if (result.value) {
        //         log.debug("Picked ENGLISH");
        //         ipcRenderer.send("test:language", ENGLISH);
        //     } else if (result.dismiss === swal.DismissReason.cancel) {
        //         log.debug("Picked LATIN");
        //         ipcRenderer.send("test:language", LATEIN);
        //     }
        // })


        ipcRenderer.send("program:ready");
        log.debug('[MW] MainWindow Loaded, JS done ...');
    </script>
</body>

</html>