<!DOCTYPE html>
<html>
<title>Vokabeltrainer</title>
<link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="assets/css/app.css">
<link rel="stylesheet" href="assets/css/colors.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">

</head>

<body>
    <header class="bg-green">
        <img src="assets/images/vocabulary-names.png" class="mx-auto d-block" style="width: 474px; height: 82px;" alt="Card image cap">
        <!-- <h1 class="text-center">Vocabulary Trainer</h1> -->
    </header>

    <div class="container-fluid body-content">
        <div id="navigationsCards" class="row">
            <div class="col-lg-12 keyvisual">
                <img class="card-img-top" src="assets/images/vocabulary.jpg" alt="Card image cap">
            </div>
        </div>


        <div id='testCard' class="row">
            <div class="col-sm-12 col-lg-12 col-xl-12">
                <!-- VOCABULARY CARD -->
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="mr-auto p-2">
                                <h2 id="vocabulary-word">No Data</h2>
                            </div>
                            <div class="p-2 bd-highlight">
                                <span id="vocabulary-correct" class="badge badge-success" data-badge-caption="Correct">Correct 4</span>
                            </div>
                            <div class="p-2 bd-highlight">
                                <span id="vocabulary-error" class="badge badge-danger right" data-badge-caption="Error">Error 4</span>
                            </div>
                            <div class="p-2 bd-highlight">
                                <span id="vocabulary-remaining" class="badge badge-info" data-badge-caption="Remaining">Remaining 4</span>
                            </div>
                            <div class="p-2 bd-highlight">
                                <button id="test-close" type="button" class="close" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div id="errorDisplay" class="col-12">

                            </div>
                        </div>
                    </div>
                    <form onsubmit="return false">
                        <div class="form-group">
                            <div class="card-body">



                                <div class="row">
                                    <div class="col-3">
                                        <label for="exampleInputEmail1">Your translation: </label>
                                    </div>
                                    <div class="col-6">
                                        <input id="vocabulary-translation" size="30" class="form-control" placeholder="..type it here .." autofocus>
                                        <small id="emailHelp" class="form-text text-muted">Provide the translation and press Return or submit.</small>
                                    </div>
                                    <div class="col-3">
                                        <button type="submit" class="btn btn-primary">Submit</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </form>
                </div>
            </div>
            <!-- <div class="col-4">
                <div id='errorCard' class="card">
                    <div class="card-header">
                        <h2>Vocabulary Errors</h2>
                    </div>
                    <div class="card-body">
                        <ul id="errorList"></ul>
                    </div>
                </div>
            </div> -->

        </div>
    </div>
    <footer class="footer bg-green">
        <div class="container">


            <div class="row">
                <div class="col-5">
                   <div  id="fileInfoElement" >No File Information</div>
                    <button id="editData" class="btn btn-default">Edit ..</button>
                    <button id="loadFileButton" class="btn btn-primary">Load File ...</button>
                    <button id="showParseErrors" type="button" class="btn btn-danger">

                        <span id="showParseErrorCount" class="badge badge-light">4</span>
                    </button>
                </div>

                <div class="col-2">
                    <div></div>
                </div>

                <div class="col-5">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="speechActive">
                        <label class="form-check-label" for="exampleCheck1">Speech</label> <i>(Version: 23.04.2018)</i>
                    </div>
                    <form onsubmit="return false">
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <select id="runtesttype" class="form-control">
                                    <option value="DE" selected>Deutsch</option>
                                    <option value="EN">English</option>
                                    <!--option value="MIX">Mixed</option-->

                                </select>
                            </div>
                            <select id="runtestcount" class="form-control">
                                <option value="20">20 words</option>
                                <option value="3" selected>30 words</option>
                                <option value="40">40 words</option>
                                <option value="50">50 words</option>
                                <option value="100">All</option>
                            </select>
                            <div class="input-group-append">
                                <button id="runtest" class="btn btn-success">Start</button>

                            </div>
                        </div>
                    </form>


                </div>
                </form>
            </div>
        </div>
    </footer>
    </div>
    <script>
        const log = require('electron-log');
        log.debug('[MW] mainWindow.html');
        const electron = require('electron');
        const swal = require('sweetalert2');
        const say = require('say');

        var parseErrorsList = []; // store last parseErrors

        const {
            ipcRenderer
        } = electron;

        // Buttons
        const runTestButton = document.querySelector('#runtest');
        const editDataButton = document.querySelector('#editData');
        const runTestCountElement = document.querySelector('#runtestcount');
        const runTestTypeElement = document.querySelector('#runtesttype');
        const loadFileButton = document.querySelector('#loadFileButton');

        const fileInfoElement = document.querySelector('#fileInfoElement');
        const wordElement = document.querySelector('#vocabulary-word');
        const translationElement = document.querySelector('#vocabulary-translation');
        const errorElement = document.querySelector('#errorDisplay');
        //  const errorCardElement = document.querySelector('#errorCard');
        // const parseErrorsElement = document.querySelector('#parse-errors-element');
        const parseErrorsText = document.querySelector('#parse-errors');
        const showParseErrorsButton = document.querySelector('#showParseErrors');
        const showParseErrorsCountElement = document.querySelector('#showParseErrorCount');
        const speechActiveCheckBox = document.querySelector('#speechActive');

        const form = document.querySelector('form');

        const testFormCloseElement = document.querySelector('#test-close');
        const testErrorElement = document.querySelector('#vocabulary-error');
        const testCorrectElement = document.querySelector('#vocabulary-correct');
        const testRemainingElement = document.querySelector('#vocabulary-remaining');
        const resultsElement = document.querySelector('#vocabulary-results');

        const testCardElement = document.querySelector('#testCard');
        const navigationCardsElement = document.querySelector('#navigationsCards');

        function showTest() {
            log.debug('[MW] show tests ..');
            navigationCardsElement.hidden = true;
            testCardElement.hidden = false;

            runTestButton.disabled = true;
            editDataButton.disabled = true;
            runTestTypeElement.disabled = true;
            runTestCountElement.disabled = true;
            loadFileButton.disabled = true;

        }

        function endTest() {
            log.debug('[MW] hide tests ..');
            testCardElement.hidden = true;
            navigationCardsElement.hidden = false;

            errorElement.innerHTML = '';
            runTestButton.disabled = false;
            editDataButton.disabled = false;
            runTestTypeElement.disabled = false;
            runTestCountElement.disabled = false;
            loadFileButton.disabled = false;
        }


        //  show file info
        ipcRenderer.on('test:fileInfo', function (e, vData) {
            log.debug('[MW] test:fileInfo vData: %s', vData.hasError);
            //    log.info(vData.parseErrors);
            log.debug('[MW] test:fileName: %s / %s', vData.fileName, vData.fullPath);
            fileInfoElement.innerHTML = "Vocabulary: " + vData.fileName + " (" + vData.size + ")";
            //vData.printInfo();
            // set main display fr file info
            if (vData.hasError) {
                parseErrorsList = vData.parseErrors;
                showParseErrorsButton.className = "btn btn-danger";
                showParseErrorsCountElement.innerHTML = vData.parseErrors.length;
            } else {
                parseErrorsList = [];
                showParseErrorsButton.className = "btn btn-success";
                showParseErrorsCountElement.innerHTML = "OK";
                // popup data remember data for later
            }
        });

        //  show question
        ipcRenderer.on('test:display', function (e, testRun) {
            log.debug('[MW] test:display');
            log.debug(testRun);
            wordElement.innerHTML = testRun.currentEntry.ask;
            var remaining = testRun.targetCount - testRun.correct - testRun.error;
            testRemainingElement.innerHTML = remaining;
            testErrorElement.innerHTML = testRun.error;
            // reset class
            testCorrectElement.innerHTML = testRun.correct;
            log.debug('[MW] Display StatS : Remaining %s = Total %s - Correct %s - Error %s', remaining,
                testRun.total, testRun.correct, testRun.error);
            translationElement.focus();
        });

        // show answer
        ipcRenderer.on('test:result', function (e, testRun) {
            var spanElement = document.createElement("div");
            if (testRun.answerIsCorrect) {
                spanElement.innerHTML = "Richtig!";
                spanElement.className = "alert alert-success"; //role="alert"
                // spanElement.className = "animated bounce";
                // testCorrectElement.className += " animated wobble";
                log.info('[MW] test:result OK');
         
            } else {
                log.debug('[MW] ***** CORRECT IS %s', testRun.correctTranslations[0]);
                var correctTranslationsText = "";
                for (var ict = 0; ict < testRun.correctTranslations.length; ict++) {
                    if (correctTranslationsText.length > 0) {
                        correctTranslationsText += " / ";
                    }
                    correctTranslationsText += testRun.correctTranslations[ict];
                }
                spanElement.innerHTML = "Richtig w√§re: " + correctTranslationsText;
                spanElement.className = "alert alert-danger"; //role="alert"
                if (testRun.type == "DE" && speechActiveCheckBox.checked) {
                    say.speak(testRun.correctTranslations[0]); // there is always only one
                }
                log.info('[MW] test:result Wrong : %s', correctTranslationsText);
            }
            errorElement.appendChild(spanElement);
        });

        // show over
        ipcRenderer.on('test:over', function (e, testRun) {
            log.info('[MW] test:over Got result ');
            endTest();
            var successMessage = "You did a test with <br/><span class='text-primary'>" + testRun.targetCount +
                " words</span> , you made <br/><span class='text-danger'>" + testRun.error +
                " errors</span> and <br/><span class='text-success'>" + testRun.correct +
                " correct</span> answers!";

            if (testRun.grade < 2) {
                swal("NOTE: " + testRun.grade + " - Great job!", successMessage, "success");
            } else if (testRun.grade < 3) {
                swal("NOTE: " + testRun.grade + " - Good job!", successMessage, "info");
            } else if (testRun.grade < 4) {
                swal("NOTE: " + testRun.grade + " - Time to Improve!", successMessage, "warning");
            } else {
                swal("NOTE: " + testRun.grade + " - Failed!", successMessage, "error");
            }
            var liElement = document.createElement("li");
            liElement.innerHTML = "<h4>Grade " + testRun.grade + "</h4> (" + testRun.vData.fileName + ")<br/> " +
                successMessage;
            resultsElement.appendChild(liElement);
        });


        testFormCloseElement.addEventListener('click', closeTestRun);

        function closeTestRun() {
            log.debug('[MW] endTest');
            endTest();
        }



        showParseErrorsButton.addEventListener('click', closeForm);

        function closeForm() {
            log.info('[MW] parseErrors 2');
            var errors = "";
            if (parseErrorsList && parseErrorsList.length > 0) {
                errors = '<ul class="list-group">';
                for (var i = 0; i < parseErrorsList.length; i++) {
                    var error = parseErrorsList[i];
                    if (error.spellingError) {
                        errors += '<li class="list-group-item">' + error.highlightedWord +
                            " <br/>" +
                            "<small>" + error.error + "</small></li>";
                    } else {
                        errors += '<li class="list-group-item"><span class="text-danger">' + error.word +
                            "</span>  <i>(Data: " + error.raw + ")</i><br/>" +
                            "<small>" + error.error + "</small></li>";
                    }
                }
                errors += "</ul>";
                log.debug("ERRORS" + errors);
                swal("Errors in File!", errors, "error");
            } else {
                swal("No Errors in File!", "Good Job!", "success");
            }
        }

        //
        // runtest
        //
        runTestButton.addEventListener('click', runTest);

        function runTest(e) {
            var count = runTestCountElement.value;
            var type = runTestTypeElement.value;
            log.debug("Run %s with %s", count, type);
            ipcRenderer.send("test:run", count, type);
            showTest();
        }

        editDataButton.addEventListener('click', showEdit);

        function showEdit(e) {
            ipcRenderer.send("data:showEdit");
        }

        // submit answer
        form.addEventListener('submit', function () {


            var check = {
                word_displayed: wordElement.innerHTML,
                translation_entered: translationElement.value
                //   correct_translations: "" // set in check function
            };
            log.info('[MW] Submitting %s/%s', check.word_displayed, check.translation_entered);
            ipcRenderer.send("test:answer", check);

            testErrorElement.className = "badge badge-danger right";
            testCorrectElement.className = "badge badge-success";
            translationElement.value = "";
            errorElement.innerHTML = "";
        });


        // loaddata
        loadFileButton.addEventListener('click', loadTest);

        function loadTest(e) {
            ipcRenderer.send("test:load")
        }

        endTest();
        ipcRenderer.send("program:ready");
        log.info('[MW] MainWindow Loaded, JS done ...');
    </script>
</body>

</html>